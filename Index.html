<!DOCTYPE html>
<html>
<head>
    <title>VR Whack-a-Mole Game</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial;
            font-size: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.5);
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div>Score: <span id="score">0</span></div>
        <div>Time: <span id="timer">30</span>s</div>
        <div>Debug: <span id="debug">Waiting for you to click the green button...</span></div>
    </div>

    <a-scene background="color: #87CEEB">
        <!-- Camera with cursor -->
        <a-camera>
            <a-cursor 
                position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                material="color: white; shader: flat"
                cursor="fuse: true; fuseTimeout: 1000">
            </a-cursor>
        </a-camera>

        <!-- Ground -->
        <a-plane 
            position="0 0 -4" 
            rotation="-90 0 0" 
            width="10" 
            height="10" 
            color="#4CC417">
        </a-plane>

        <!-- Start Button -->
        <a-box 
            id="start-button"
            position="0 1.5 -4" 
            width="2" 
            height="0.8" 
            depth="0.2" 
            color="#00ff00">
        </a-box>
        
        <!-- Start Button Text -->
        <a-text 
            id="start-text"
            position="0 1.5 -3.9" 
            value="CLICK TO START!" 
            align="center" 
            color="black" 
            width="8"
            font="roboto">
        </a-text>

        <!-- Game Title -->
        <a-text 
            position="0 2.5 -4" 
            value="VR WHACK-A-MOLE" 
            align="center" 
            color="white" 
            width="10"
            font="roboto">
        </a-text>

        <!-- Mole positions -->
        <a-entity id="mole-1" position="-2 0 -3"></a-entity>
        <a-entity id="mole-2" position="0 0 -3"></a-entity>
        <a-entity id="mole-3" position="2 0 -3"></a-entity>
        <a-entity id="mole-4" position="-2 0 -4"></a-entity>
        <a-entity id="mole-5" position="0 0 -4"></a-entity>
        <a-entity id="mole-6" position="2 0 -4"></a-entity>
        <a-entity id="mole-7" position="-2 0 -5"></a-entity>
        <a-entity id="mole-8" position="0 0 -5"></a-entity>
        <a-entity id="mole-9" position="2 0 -5"></a-entity>

        <!-- Holes -->
        <a-circle position="-2 0.01 -3" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="0 0.01 -3" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="2 0.01 -3" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="-2 0.01 -4" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="0 0.01 -4" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="2 0.01 -4" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="-2 0.01 -5" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="0 0.01 -5" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>
        <a-circle position="2 0.01 -5" rotation="-90 0 0" radius="0.3" color="#654321"></a-circle>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 10 0" color="#ffffff"></a-light>
    </a-scene>

    <script>
        // GAME VARIABLES - ALL START AS FALSE/INACTIVE
        let gameStarted = false;
        let gameActive = false;
        let score = 0;
        let timeLeft = 30;
        let gameTimer = null;

        const scoreElement = document.getElementById('score');
        const timerElement = document.getElementById('timer');
        const debugElement = document.getElementById('debug');

        function updateDebug(message) {
            debugElement.textContent = message;
            console.log("DEBUG: " + message);
        }

        // WAIT FOR SCENE TO LOAD, THEN SET UP BUTTON CLICK
        document.querySelector('a-scene').addEventListener('loaded', function() {
            updateDebug("Scene loaded. Click the green button to start!");
            
            const startButton = document.getElementById('start-button');
            const startText = document.getElementById('start-text');
            
            // ADD CLICK EVENT LISTENER TO START BUTTON
            startButton.addEventListener('click', function() {
                updateDebug("GREEN BUTTON CLICKED!");
                
                // ONLY START IF GAME HASN'T STARTED YET
                if (!gameStarted) {
                    updateDebug("Starting game now...");
                    
                    // HIDE THE BUTTON AND TEXT
                    startButton.setAttribute('visible', 'false');
                    startText.setAttribute('visible', 'false');
                    
                    // SET GAME STATE TO STARTED
                    gameStarted = true;
                    gameActive = true;
                    
                    // ACTUALLY START THE GAME
                    startTheGame();
                }
            });
        });

        // THIS FUNCTION ONLY RUNS AFTER BUTTON CLICK
        function startTheGame() {
            updateDebug("Game is starting!");
            
            // Reset game variables
            score = 0;
            timeLeft = 30;
            updateUI();
            
            // Start the countdown timer
            gameTimer = setInterval(function() {
                timeLeft--;
                updateUI();
                updateDebug(`Time left: ${timeLeft}`);
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            // Start spawning moles
            updateDebug("Starting mole spawning...");
            spawnNextMole();
        }

        // MOLE SPAWNING - ONLY RUNS IF GAME IS ACTIVE
        function spawnNextMole() {
            // CHECK IF GAME IS STILL ACTIVE
            if (!gameActive || !gameStarted) {
                updateDebug("Mole spawning stopped - game not active");
                return;
            }
            
            updateDebug("Creating a mole...");
            createMole();
            
            // SCHEDULE NEXT MOLE SPAWN
            setTimeout(function() {
                if (gameActive && gameStarted) {
                    spawnNextMole();
                }
            }, 2000);
        }

        function createMole() {
            // DOUBLE CHECK GAME IS ACTIVE
            if (!gameActive || !gameStarted) {
                return;
            }
            
            // Find available positions
            const available = [];
            for (let i = 1; i <= 9; i++) {
                const entity = document.getElementById(`mole-${i}`);
                if (entity && entity.children.length === 0) {
                    available.push(i);
                }
            }
            
            if (available.length === 0) {
                updateDebug("No positions available");
                return;
            }
            
            const pos = available[Math.floor(Math.random() * available.length)];
            const entity = document.getElementById(`mole-${pos}`);
            
            updateDebug(`Creating mole at position ${pos}`);
            
            // Create mole (mix of boxes and spheres)
            const moleTypes = ['a-box', 'a-sphere'];
            const moleType = moleTypes[Math.floor(Math.random() * moleTypes.length)];
            const mole = document.createElement(moleType);
            
            if (moleType === 'a-box') {
                mole.setAttribute('width', '0.3');
                mole.setAttribute('height', '0.3');
                mole.setAttribute('depth', '0.3');
                mole.setAttribute('color', '#8B4513');
            } else {
                mole.setAttribute('radius', '0.2');
                mole.setAttribute('color', '#654321');
            }
            
            // Add to scene
            entity.appendChild(mole);
            
            // Start underground
            mole.object3D.position.set(0, -0.5, 0);
            
            // Track if mole was hit
            let moleHit = false;
            
            // Pop up animation
            animateMoleUp(mole);
            
            // Click handler
            mole.addEventListener('click', function() {
                if (gameActive && !moleHit) {
                    moleHit = true;
                    score += 10;
                    updateUI();
                    updateDebug("Mole hit! +10 points");
                    mole.setAttribute('color', '#ff0000');
                    
                    // Quick fall down when hit
                    setTimeout(() => animateMoleDown(mole), 200);
                }
            });
            
            // Auto fall down after 3 seconds if not hit
            setTimeout(() => {
                if (mole.parentNode && !moleHit) {
                    updateDebug("Mole falling back down...");
                    animateMoleDown(mole);
                }
            }, 3000);
        }

        function animateMoleUp(mole) {
            const startTime = Date.now();
            const duration = 500;
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease out for smooth pop-up
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const y = -0.5 + (1.0 * easeProgress);
                mole.object3D.position.y = y;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }

        function animateMoleDown(mole) {
            if (!mole || !mole.parentNode) return;
            
            const startTime = Date.now();
            const duration = 400;
            const startY = mole.object3D.position.y;
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease in for smooth fall down
                const easeProgress = progress * progress;
                const y = startY + (-0.5 - startY) * easeProgress;
                mole.object3D.position.y = y;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Remove mole after it falls underground
                    removeMole(mole);
                }
            }
            
            animate();
        }

        function removeMole(mole) {
            if (mole && mole.parentNode) {
                mole.parentNode.removeChild(mole);
                updateDebug("Mole removed from scene");
            }
        }

        function updateUI() {
            scoreElement.textContent = score;
            timerElement.textContent = timeLeft;
        }

        function endGame() {
            updateDebug("Game Over!");
            gameActive = false;
            
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            alert(`Game Over! Final Score: ${score}`);
            
            // Reset for new game
            setTimeout(() => {
                gameStarted = false;
                document.getElementById('start-button').setAttribute('visible', 'true');
                document.getElementById('start-text').setAttribute('visible', 'true');
                document.getElementById('start-text').setAttribute('value', 'PLAY AGAIN?');
                updateDebug("Click to play again!");
            }, 2000);
        }

        // NO OTHER CODE RUNS AUTOMATICALLY
        updateDebug("Page loaded. Waiting for scene to load...");
    </script>
</body>
</html>
